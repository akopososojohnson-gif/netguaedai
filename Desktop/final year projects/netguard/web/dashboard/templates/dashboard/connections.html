{% extends 'dashboard/base.html' %}

{% block title %}Connections - NetGuard AI{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <span class="live-indicator">
                <span class="live-dot"></span>
                Live Network Connections
            </span>
        </div>
        <div class="search-box" style="margin: 0;">
            <input type="text" id="search-input" placeholder="Search IP, domain, or protocol...">
            <button class="btn btn-primary" onclick="searchConnections()">Search</button>
        </div>
    </div>
    
    <table id="connections-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Source</th>
                <th>Destination</th>
                <th>Domain</th>
                <th>Protocol</th>
                <th>Bytes</th>
                <th>Duration</th>
                <th>Threat</th>
            </tr>
        </thead>
        <tbody id="connections-body">
            <tr>
                <td colspan="8" style="text-align: center; color: #94a3b8; padding: 2rem;">Loading...</td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDuration(seconds) {
    if (!seconds) return '-';
    if (seconds < 1) return (seconds * 1000).toFixed(0) + 'ms';
    return seconds.toFixed(2) + 's';
}

function getThreatBadge(score, type) {
    if (score < 0.3) return '<span class="badge badge-normal">NORMAL</span>';
    if (score < 0.7) return '<span class="badge badge-warning">' + type.toUpperCase() + '</span>';
    return '<span class="badge badge-danger">' + type.toUpperCase() + '</span>';
}

async function loadConnections() {
    try {
        const response = await fetch('/api/connections/?minutes=30&limit=500');
        const data = await response.json();
        
        const tbody = document.getElementById('connections-body');
        if (data.connections.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #94a3b8; padding: 2rem;">No connections found</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.connections.map(conn => {
            const time = new Date(conn.time).toLocaleString();
            const src = `${conn.src_ip}:${conn.src_port || '-'}`;
            const dst = `${conn.dst_ip}:${conn.dst_port || '-'}`;
            const bytes = formatBytes((conn.bytes_in || 0) + (conn.bytes_out || 0));
            
            return `
                <tr>
                    <td>${time}</td>
                    <td>${src}</td>
                    <td>${dst}</td>
                    <td>${conn.domain || '-'}</td>
                    <td>${conn.protocol}</td>
                    <td>${bytes}</td>
                    <td>${formatDuration(conn.duration)}</td>
                    <td>${getThreatBadge(conn.threat_score, conn.threat_type)}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading connections:', error);
        document.getElementById('connections-body').innerHTML = 
            '<tr><td colspan="8" style="text-align: center; color: #ef4444; padding: 2rem;">Error loading data</td></tr>';
    }
}

function searchConnections() {
    const query = document.getElementById('search-input').value;
    if (!query) {
        loadConnections();
        return;
    }
    // Implement search
    alert('Search: ' + query);
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadConnections);

// Auto refresh every 5 seconds
setInterval(loadConnections, 5000);
</script>
{% endblock %}
